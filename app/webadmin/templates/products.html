{% extends 'base.html' %}
{% block content %}
<div class="page-header">
    <div>
        <h1>ูุฏุฑุช ูุญุตููุงุช</h1>
        <p class="subtext">ฺุฏูุงู ุฒุจุง ู ุฏูู ุจุฑุง ุฏุณุชูโูุง ู ุฎุฏูุงุช ุฏุฑ ูุฑูุดฺฏุงู.</p>
    </div>
</div>

<section class="panel">
    <header>
        <h2>ุงุฌุงุฏ ุฏุณุชู ุฌุฏุฏ</h2>
        <p class="muted">ุฏุณุชูโูุง ููุท ุจุฑุง ฺุฏูุงู ูุณุชูุฏ ู ููุดู ูุนุงู ูโูุงููุฏ.</p>
    </header>
    <form method="post" action="{{ url_for('products_create') }}" class="grid form-grid">
        <input type="hidden" name="type" value="category">
        <label>
            ูุงู ุฏุณุชู
            <input type="text" name="title" required placeholder="ูุซูุงู ุฎุฏูุงุช ุฌุฏุฏ">
        </label>
        <label>
            ุชุฑุชุจ ููุงุด
            <input type="number" name="sort_order" value="0" min="0">
        </label>
        <div class="form-actions">
            <button type="submit" class="btn-primary">ุงุฌุงุฏ ุฏุณุชู</button>
        </div>
    </form>
</section>

<section class="panel">
    <header>
        <h2>ุงุฌุงุฏ ูุญุตูู/ุฎุฏูุช ุฌุฏุฏ</h2>
        <p class="muted">ูุญุตููุงุช ูโุชูุงููุฏ ุฏุฑุฎูุงุณุชโูุญูุฑ ุง ุฏุงุฑุง ุญุงูุช ุงฺฉุงูุช ุจุงุดูุฏ.</p>
    </header>
    <form method="post" action="{{ url_for('products_create') }}" class="grid form-grid" id="create-product-form">
        <input type="hidden" name="type" value="product">
        <div class="section-divider">ุงุทูุงุนุงุช ูพุงู</div>
        <label class="full">
            ูุงู ูุญุตูู
            <input type="text" name="title" required placeholder="ูุซูุงู ุณุฑูุณ ุฌุฏุฏ">
        </label>
        <div class="inline-fields">
            <label>
                ูุงูุฏ (ููุท ุฏุณุชู)
                <select name="parent_id">
                    {% for p in parents %}
                    <option value="{{ p.id }}">{{ p.title }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                ุชุฑุชุจ ููุงุด
                <input type="number" name="sort_order" value="0" min="0">
            </label>
            <label class="checkbox">
                <input type="checkbox" name="available" checked>
                ููุฌูุฏ ุจุงุดุฏ
            </label>
        </div>
        <div class="inline-fields">
            <label>
                ููุช ูพุงู ({{ currency }})
                <input type="number" name="price" value="0" min="0" step="1000">
            </label>
            <label class="checkbox">
                <input type="checkbox" name="request_only" id="request-only-toggle">
                ููุท ุซุจุช ุฏุฑุฎูุงุณุช (ุจุฏูู ููุช)
            </label>
            <span class="pill">ุฏุฑ ุญุงูุช ุฏุฑุฎูุงุณุชุ ุณุงุฑ ฺฏุฒููโูุง ููู ูโุดููุฏ.</span>
        </div>

        <div class="section-divider">ุญุงูุช ุงฺฉุงูุช</div>
        <div class="inline-fields span account-block" data-account-row="new">
            <label class="checkbox">
                <input type="checkbox" name="account_enabled" id="account-enabled">
                ุญุงูุช ุงฺฉุงูุช ูุนุงู ุจุงุดุฏ
            </label>
            <label class="checkbox">
                <input type="checkbox" name="self_available" data-account-toggle="new" id="self-available">
                ุฑู ุงฺฉุงูุช ุฎูุฏู ูุนุงู ุจุงุดุฏ
            </label>
            <label>
                ููุช ุฑู ุงฺฉุงูุช ุฎูุฏู
                <input type="number" name="self_price" value="0" min="0" step="1000">
            </label>
            <label class="checkbox">
                <input type="checkbox" name="pre_available" data-account-toggle="new" id="pre-available">
                ุงฺฉุงูุช ุงุฒ ูพุด ุณุงุฎุชู ุดุฏู ูุนุงู ุจุงุดุฏ
            </label>
            <label>
                ููุช ุงฺฉุงูุช ุขูุงุฏู
                <input type="number" name="pre_price" value="0" min="0" step="1000">
            </label>
        </div>
        <div class="inline-fields span credentials-box" data-credentials-for="new">
            <label class="checkbox">
                <input type="checkbox" name="require_username" id="require-username">
                ฺฏุฑูุชู ูุฒุฑ/ุงูู
            </label>
            <label class="checkbox">
                <input type="checkbox" name="require_password" id="require-password">
                ฺฏุฑูุชู ูพุณูุฑุฏ
            </label>
            <span class="hint-inline">ุฏุฑ ุตูุฑุช ูุนุงู ุจูุฏู (ุจู ุฌุฒ ุญุงูุช ยซููุท ุซุจุช ุฏุฑุฎูุงุณุชยป) ุงุฒ ูุดุชุฑ ูพุฑุณุฏู ูโุดููุฏ.</span>
        </div>
        <label class="full">
            ุชูุถุญุงุช
            <textarea name="description" rows="3" placeholder="ุชูุถุญ ฺฉูุชุงู ุจุฑุง ุตูุญูู ูุญุตูู"></textarea>
        </label>
        <div class="form-actions">
            <button type="submit" class="btn-primary">ุงุฌุงุฏ ูุญุตูู</button>
        </div>
    </form>
</section>

<section class="panel">
    <header>
        <h2>ููุฑุณุช ฺฉุงูู ูุญุตููุงุช ู ุฏุณุชูโูุง</h2>
        <p class="muted">ููุชโูุง ุจุฑ ุญุณุจ {{ currency }} ูุณุชูุฏ. ูุฑ ุฑุฏู ูุงุจู ูุฑุงุด ูุณุชูู ุงุณุช.</p>
    </header>
    <form method="post" action="{{ url_for('products_bulk_update') }}" id="bulk-form">
        <div class="table-wrapper">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>ุนููุงู</th>
                        <th>ฺุฏูุงู</th>
                        <th>ฺฏุฒููโูุง</th>
                        <th>ูุงูุฏ</th>
                        <th>ุชูุถุญุงุช</th>
                        <th>ุนููุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in products %}
                    <tr data-product-row="{{ item.id }}">
                    <td>
                        <div class="tree-title" style="--depth: {{ item.depth }};">
                            <span class="node-tag {{ 'category' if item.is_category else 'product' }}">{{ '๐' if item.is_category else '๐๏ธ' }}</span>
                            <input type="hidden" name="is_category-{{ item.id }}" value="{{ 1 if item.is_category else 0 }}">
                            <input type="text" name="title-{{ item.id }}" value="{{ item.title }}" required>
                            <div class="path muted">{{ item.path_display }}</div>
                        </div>
                    </td>
                    <td>
                        <div class="inline-fields">
                            <label>
                                ุชุฑุชุจ
                                <input type="number" name="sort_order-{{ item.id }}" value="{{ item.sort_order or 0 }}" min="0">
                            </label>
                            <p class="muted">ููุน: {{ 'ุฏุณุชู' if item.is_category else 'ูุญุตูู' }}</p>
                        </div>
                    </td>
                    <td>
                        <div class="stack">
                            <div class="inline-fields">
                                <label>ููุช ูพุงู
                                    <input type="number" name="price-{{ item.id }}" value="{{ item.price }}" min="0" step="1000" {% if item.is_category %}disabled{% endif %}>
                                </label>
                                <label class="checkbox">
                                    <input type="checkbox" name="available-{{ item.id }}" {% if item.available %}checked{% endif %} {% if item.is_category %}disabled{% endif %}>
                                    ูุนุงู
                                </label>
                            </div>
                            {% if not item.is_category %}
                            <div class="inline-fields">
                                <label class="checkbox">
                                    <input type="checkbox" name="request_only-{{ item.id }}" {% if item.request_only %}checked{% endif %}>
                                    ููุท ุซุจุช ุฏุฑุฎูุงุณุช
                                </label>
                                <label class="checkbox">
                                    <input type="checkbox" name="account_enabled-{{ item.id }}" {% if item.account_enabled %}checked{% endif %}>
                                    ุญุงูุช ุงฺฉุงูุช ูุนุงู
                                </label>
                            </div>
                            <div class="inline-fields account-block" data-account-row="{{ item.id }}">
                                <label class="checkbox">
                                    <input type="checkbox" name="self_available-{{ item.id }}" {% if item.self_available %}checked{% endif %} data-account-toggle="{{ item.id }}">
                                    ุฑู ุงฺฉุงูุช ุฎูุฏู
                                </label>
                                <label>
                                    ููุช ุฎูุฏู
                                    <input type="number" name="self_price-{{ item.id }}" value="{{ item.self_price }}" min="0" step="1000">
                                </label>
                                <label class="checkbox">
                                    <input type="checkbox" name="pre_available-{{ item.id }}" {% if item.pre_available %}checked{% endif %} data-account-toggle="{{ item.id }}">
                                    ุงฺฉุงูุช ุขูุงุฏู
                                </label>
                                <label>
                                    ููุช ุขูุงุฏู
                                    <input type="number" name="pre_price-{{ item.id }}" value="{{ item.pre_price }}" min="0" step="1000">
                                </label>
                            </div>
                            <div class="inline-fields credentials-box" data-credentials-for="{{ item.id }}">
                                <label class="checkbox">
                                    <input type="checkbox" name="require_username-{{ item.id }}" {% if item.require_username %}checked{% endif %}>
                                    ฺฏุฑูุชู ูุฒุฑ/ุงูู
                                </label>
                                <label class="checkbox">
                                    <input type="checkbox" name="require_password-{{ item.id }}" {% if item.require_password %}checked{% endif %}>
                                    ฺฏุฑูุชู ูพุณูุฑุฏ
                                </label>
                                <span class="hint-inline">ููฺฏุงู ุฎุฑุฏ ุฏุฑ ุจุงุช ููุงุด ุฏุงุฏู ูโุดูุฏ.</span>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if item.is_category %}
                        <p class="muted">โ</p>
                        {% else %}
                        <select name="parent_id-{{ item.id }}">
                            {% for p in parents %}
                            <option value="{{ p.id }}" {% if (item.parent_id or 0) == p.id %}selected{% endif %}>{{ p.title }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    </td>
                    <td>
                        <textarea name="description-{{ item.id }}" rows="2">{{ item.description }}</textarea>
                    </td>
                    <td class="actions">
                        <button type="submit" class="btn-danger" formnovalidate formaction="{{ url_for('products_delete', product_id=item.id) }}" onclick="return confirm('ุญุฐู ุงู ููุฑุฏุ ุฒุฑูุฌููุนูโูุง ูุฒ ุญุฐู ูโุดููุฏ.');">ุญุฐู</button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="empty">ูููุฒ ูุญุตูู ุซุจุช ูุดุฏู ุงุณุช.</td></tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn-primary">ุชุงุฏ ฺฉู</button>
        </div>
    </form>
</section>
<script>
    const initCreateFormGuards = () => {
        const form = document.getElementById('create-product-form');
        if (!form) return;

        const requestOnly = form.querySelector('#request-only-toggle');
        const accountEnabled = form.querySelector('#account-enabled');
        const selfToggle = form.querySelector('#self-available');
        const preToggle = form.querySelector('#pre-available');
        const basePrice = form.querySelector('input[name="price"]');
        const selfPrice = form.querySelector('input[name="self_price"]');
        const prePrice = form.querySelector('input[name="pre_price"]');
        const reqUsername = form.querySelector('#require-username');
        const reqPassword = form.querySelector('#require-password');
        const credentialsRow = form.querySelector('[data-credentials-for="new"]');

        const syncRequestOnlyState = () => {
            const locked = Boolean(requestOnly && requestOnly.checked);
            if (accountEnabled) {
                accountEnabled.disabled = locked;
                if (locked) accountEnabled.checked = false;
            }
            if (basePrice) {
                basePrice.disabled = locked;
                if (locked) basePrice.value = '0';
            }
            [selfToggle, preToggle, selfPrice, prePrice, reqUsername, reqPassword].forEach((el) => {
                if (!el) return;
                el.disabled = locked;
                if (locked && el.type === 'checkbox') el.checked = false;
            });
            if (credentialsRow) credentialsRow.classList.toggle('hidden', locked);
        };

        if (requestOnly) requestOnly.addEventListener('change', syncRequestOnlyState);

        syncRequestOnlyState();
    };

    const clampRowState = (row) => {
        const id = row.dataset.productRow;
        const requestOnly = row.querySelector(`[name="request_only-${id}"]`);
        const accountEnabled = row.querySelector(`[name="account_enabled-${id}"]`);
        const priceInput = row.querySelector(`[name="price-${id}"]`);
        const selfToggle = row.querySelector(`[name="self_available-${id}"]`);
        const preToggle = row.querySelector(`[name="pre_available-${id}"]`);
        const selfPrice = row.querySelector(`[name="self_price-${id}"]`);
        const prePrice = row.querySelector(`[name="pre_price-${id}"]`);
        const reqUsername = row.querySelector(`[name="require_username-${id}"]`);
        const reqPassword = row.querySelector(`[name="require_password-${id}"]`);
        const credentialsRow = row.querySelector(`[data-credentials-for="${id}"]`);

        const requestMode = Boolean(requestOnly && requestOnly.checked);

        if (requestOnly) {
            if (accountEnabled) {
                accountEnabled.disabled = requestMode;
                if (requestMode) accountEnabled.checked = false;
            }
            if (priceInput) {
                priceInput.disabled = requestMode;
                if (requestMode) priceInput.value = '0';
            }
        }
        if (!requestMode) {
            if (accountEnabled) accountEnabled.disabled = false;
            if (priceInput) priceInput.disabled = false;
        }

        [selfToggle, preToggle, selfPrice, prePrice, reqUsername, reqPassword].forEach((el) => {
            if (!el) return;
            el.disabled = requestMode;
            if (requestMode && el.type === 'checkbox') el.checked = false;
        });

        if (credentialsRow) credentialsRow.classList.toggle('hidden', requestMode);
    };

    const initBulkGuards = () => {
        document.querySelectorAll('[data-product-row]').forEach((row) => {
            const id = row.dataset.productRow;
            ['request_only', 'account_enabled', 'self_available', 'pre_available'].forEach((name) => {
                const input = row.querySelector(`[name="${name}-${id}"]`);
                if (input) input.addEventListener('change', () => clampRowState(row));
            });
            clampRowState(row);
        });
    };

    initCreateFormGuards();
    initBulkGuards();
</script>
{% endblock %}
